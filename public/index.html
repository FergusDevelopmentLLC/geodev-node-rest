<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>United States Federal Lands</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />

    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Francois+One' rel='stylesheet' type='text/css'>
    <link href='http://getbootstrap.com/dist/css/bootstrap.css' rel='stylesheet' type='text/css'>
    <style>
        body {
          margin: 0;
          padding: 0;
          font-family: Francois One, sans-serif;
          font-size: 15px;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
        #legend {
          position:absolute;
          z-index: 401;
          bottom: 20px;
          left: 20px;
          width: 251px;
          background-color: #fff;
          padding:10px;
          border-radius: 5px;
        }

        #owner-checkboxes-wrapper {
          margin: 0 0 5px 0;
        }

        h4 {
          margin: 0 0 10px 0;
          text-align: center;
        }
    </style>
</head>

<body>
  <div id="legend">
    <h4>U.S. Federal Lands</h4>
    <div id="owner-checkboxes-wrapper">
      <span id='ownerCheckboxes'/>
    </div>
    <div class="btn-group" data-toggle="buttons">
      <label class="btn btn-primary active"><input type="radio" name="datasource" id="geojson" value="geojson" />GEOJSON</label>
      <label class="btn btn-primary"><input type="radio" name="datasource" id="postgres" value="postgres" />POSTGRES</label>
      <label class="btn btn-primary"><input type="radio" name="datasource" id="mongo" value="mongo" />MONGO</label>
    </div>
  </div>

    <div id='map'></div>

    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <script src="http://spin.js.org/spin.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>

    <script>

      var map = L.map('map', {
        center: [39.094145, -105.683906],
        zoom: 4,
      });

      var tiles = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      var layerGroupsDisplayed = {};
      var apisource = 'geojson';
      var spinner;

      function populateLegend(data){
        var checkboxes = '';
        for (var owner in data) {
          checkboxes += "<input type='checkbox' name='owner_code' id='" + data[owner].owner_code + "' value='" + data[owner].id + "' color='" + data[owner].color + "' owner_code='" + data[owner].owner_code + "' owner='" + data[owner].owner + "'> <label for='" + data[owner].owner_code + "'><span style='color:" + data[owner].color + "'>" + data[owner].owner + "</span></label></br>";
        }
        $('#ownerCheckboxes').html(checkboxes);
        handleCheckboxClicks();
        $("#NPS").click();
      };

      function getLayerGroupFor(owner_code, strokeColor) {
        //console.log("from api");
        var lgFromApi = new L.layerGroup();
        var geoJsonUrl = getGeoJsonUrl(owner_code);
        $('.spinner').show();
        $.getJSON(geoJsonUrl, function(data) {
          $('.spinner').hide();
          var dataLayer = L.geoJson(data, {
            style: function(feature) {
              return {color: strokeColor, fillColor: strokeColor, stroke: true, strokefillOpacity: .4};
            }
          });
          lgFromApi.addLayer(dataLayer);
        });
        return lgFromApi;
      }

      function handleCheckboxClicks() {
        $("input[type='checkbox'][name='owner_code']").change(function() {
          var id = $(this).attr('value');
          var owner_code = $(this).attr('owner_code');
          var owner = $(this).attr('owner');
          var strokeColor = $(this).attr('color');
          if(this.checked) {
            if(layerGroupsDisplayed[owner_code]) { //check layerGroupsToDisplay first, if not there then get it from the API
              //console.log("from layerGroupsDisplayed");
              layerGroupsDisplayed[owner_code].lg.addTo(map);
            }
            else {
              var lg = getLayerGroupFor(owner_code, strokeColor);
              lg.addTo(map);
              //console.log(lg._leaflet_id);
              layerGroupsDisplayed[owner_code] = {
                leafletid: lg._leaflet_id, lg: lg
              };
            };
          }
          else {
            if(map.hasLayer(layerGroupsDisplayed[owner_code].lg))
              map.removeLayer(layerGroupsDisplayed[owner_code].lg);
          }
        })
      }

      function getGeoJsonUrl(owner_code) {
        var url = "data/" + owner_code + ".geojson";
        if(apisource == 'geojson'){
          url = "data/" + owner_code + ".geojson";
          apisource = 'geojson';
          console.log('Map data geojson source is geojson file: ' + url);
        }
        else if(apisource == 'postgres'){
          url = "/fedlandsP/forOwnerCode/" + owner_code;
          apisource = 'postgres';
          console.log('Map data geojson source is postgres api: ' + url);
        }
        else if(apisource == 'mongo'){
          url = "/fedlandsM/forOwnerCode/" + owner_code;
          apisource = 'mongo';
          console.log('Map data geojson source is mongo api: ' + url);
        }
        return url;
      }

      function getOwnersUrl(owner_code) {
        var url = "data/owners.json";
        if(apisource == 'geojson'){
          url = "data/owners.json";
          apisource = 'geojson';
          console.log('U.S. Federal lands source is local file: ' + url);
        }
        else if(apisource == 'postgres'){
          url = "/ownersP";
          apisource = 'postgres';
          console.log('U.S. Federal lands source is postgres api: ' + url);
        }
        else if(apisource == 'mongo'){
          url = "/ownersM";
          apisource = 'mongo';
          console.log('Map data geojson source is mongo api: ' + url);
        }
        return url;
      }

      function handleDataSourceClick() {
        $('input[type=radio][name=datasource]').change(function() {
          init();
          $(this).parent().attr('class', 'btn btn-primary active');
          if(this.value == "geojson"){
            //console.log('geojson');
            apisource = "geojson";
            $(this).parent().next().attr('class', 'btn btn-primary');
            $(this).parent().next().next().attr('class', 'btn btn-primary');
          }
          else if (this.value == "postgres") {
            //console.log('postgres');
            apisource = "postgres";
            $(this).parent().prev().attr('class', 'btn btn-primary');
            $(this).parent().next().attr('class', 'btn btn-primary');
          }
          else if (this.value == "mongo") {
            //console.log('mongo');
            apisource = "mongo";
            $(this).parent().prev().attr('class', 'btn btn-primary');
            $(this).parent().prev().prev().attr('class', 'btn btn-primary');
          }
        });
      }

      function createSpinner() {
        //http://spin.js.org/
        var target = document.getElementById('map');
        var opts = {
          lines: 13 // The number of lines to draw
        , length: 28 // The length of each line
        , width: 14 // The line thickness
        , radius: 42 // The radius of the inner circle
        , scale: 1 // Scales overall size of the spinner
        , corners: 1 // Corner roundness (0..1)
        , color: '#000' // #rgb or #rrggbb or array of colors
        , opacity: 0.25 // Opacity of the lines
        , rotate: 0 // The rotation offset
        , direction: 1 // 1: clockwise, -1: counterclockwise
        , speed: 1 // Rounds per second
        , trail: 60 // Afterglow percentage
        , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
        , zIndex: 2e9 // The z-index (defaults to 2000000000)
        , className: 'spinner' // The CSS class to assign to the spinner
        , top: '50%' // Top position relative to parent
        , left: '50%' // Left position relative to parent
        , shadow: false // Whether to render a shadow
        , hwaccel: false // Whether to use hardware acceleration
        , position: 'absolute' // Element positioning
        }
        spinner = new Spinner(opts).spin(target);
      }

      function init() {
        layerGroupsDisplayed = {};

        createSpinner();

        map.eachLayer(function (layer) {
          if(!layer._url){
            map.removeLayer(layer);
            $('input[type=checkbox]').each(function(){
              this.checked = false;
            });
          }
        });

        var jsonUrl = getOwnersUrl();
        $.getJSON(jsonUrl, function (data) {
          populateLegend (data);
        });
      }

      $(document).ready(function() {
        handleDataSourceClick();
        init();
      });

    </script>
</body>
</html>
